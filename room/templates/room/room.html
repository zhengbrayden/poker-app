{% extends 'core/base.html' %}

{% block title %}{{ lobby.get_name }} | {% endblock %}
{% block content %}
<div class="p-10 lg:p-20 text-center">
    <h1 class="text-3xl lg:text-6xl text-white">{{ lobby.get_name }}</h1>
</div>

<div class="lg:w-2/4 mx-4 lg:mx-auto p-4 bg-white rounded-xl">
    <div class="chat-messages space-y-3" id="chat-messages">
        {% for message in messages %}
            <div class="p-4 bg-gray-200 rounded-xl">
                <p>{{ message }}</p>
            </div>
        {% endfor %}
    </div>
</div>

<div id = 'body'>
    <!-- must display the amount of money the player has -->
     <span id="button-span"></span>
     <span>Balance: {{ player.get_bank }}</span>
</div>
{% endblock %}

{% block scripts %}
{{ is_leader|json_script:"json-is-leader" }}
{{ slug |json_script:"json-slug" }}

<script>
    //the page has just loaded the messages are displayed. NOw display the start button if it is a leader, display the amount of money as well

    const isLeader = JSON.parse(document.getElementById('json-is-leader').textContent)

    if (isLeader) {
        document.getElementById('button-span').innerHTML = `<button id="start-button">Start</button>`
    }

    //open websocket connection
    const slug = JSON.parse(document.getElementById('json-slug').textContent)

    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/' + slug + '/'
    );

    //add functionality to button
    document.getElementById("start-button").onclick = function(e) {
        e.preventDefault();

        chatSocket.send(JSON.stringify({
            'command': 'start'
        }));

        return false;
    }

    //display messages from server to chat
    chatSocket.onmessage = function(e) {
        console.log('onmessage')

        const data = JSON.parse(e.data);
        //when a message is sent, the content should be displayed

        if (data.message) {
            let html = '<div class="p-4 bg-gray-200 rounded-xl">'
            html += '<p>' + data.message + '</p></div>';

            document.querySelector('#chat-messages').innerHTML += html;
        } else {
            alert('The message was empty');
        }
    };

    chatSocket.onclose = function(e) {
        console.log('onclose')
    };

    // for raise form, Why do we need a form?

    // document.querySelector('#chat-message-submit').onclick = function(e) {
    //     e.preventDefault();
    //     const messageInputDom = document.querySelector('#chat-message-input');
    //     const message = messageInputDom.value;

    //     chatSocket.send(JSON.stringify({
    //         'message': message,
    //         'username' : userName,
    //         'room': roomName
    //     }));

    //     messageInputDom.value = '';

    //     return false;
    // }
</script>
{% endblock %}